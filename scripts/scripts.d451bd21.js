"use strict";angular.module("kanColleViewerMomiApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/dock/:dockId",{templateUrl:"views/dock.html",controller:"DockCtrl"}).when("/girl/:girlId",{templateUrl:"views/girl.html",controller:"GirlCtrl"}).when("/girls",{templateUrl:"views/girls.html",controller:"GirlsCtrl"}).when("/girlsstat",{templateUrl:"views/girlsstat.html",controller:"GirlsStatCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("kanColleViewerMomiApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("kanColleViewerMomiApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("kanColleViewerMomiApp").service("SharedObject",["WebSocket",function(a){function b(a){d.forEach(function(b){b.api==a&&b.callback()})}console.log("SharedObject created");var c={portJson:null,api_start2Json:null,slot_itemJson:null};a.subscribe(function(a){var d=JSON.parse(a);switch(console.log("Data Incoming: "+d.api),d.api){case"port":c.portJson=d.data,b("port");break;case"api_start2":c.api_start2Json=d.data,b("api_start2");break;case"slot_item":c.slot_itemJson=d.data,b("slot_item")}});var d=[];return c.hook=function(a,b){var c=new Object;c.api=a,c.callback=b,d.push(c)},c}]),angular.module("kanColleViewerMomiApp").factory("ShipMap",["SharedObject",function(a){return{getFleetFromPort:function(b){return a.portJson.api_data.api_ship.find(function(a){return a.api_id==b})},getShipTypeNameFromId:function(b){var c=a.api_start2Json.api_data.api_mst_stype.find(function(a){return a.api_id==b});return void 0===c?void 0:c.api_name},isOnFix:function(b){return a.portJson.api_data.api_ndock.find(function(a){return a.api_ship_id==b})},countFleetsOnFix:function(){return a.portJson.api_data.api_ndock.filter(function(a){return 1==a.api_state}).length},fetchShipStatus:function(b){return a.api_start2Json.api_data.api_mst_ship.find(function(a){return a.api_id==b})},getDockIdSheBelongsTo:function(b){console.log("Searching fleet id: "+b);var c=a.portJson.api_data.api_deck_port.find(function(a){console.log("Now searching in dock #"+a.api_id);var c=a.api_ship.indexOf(parseInt(b));return console.log("Searched index is: "+c),c>=0});return void 0!==c?a.portJson.api_data.api_deck_port.indexOf(c):void console.log("Fleet not found in deck")},getDockName:function(b){return a.portJson.api_data.api_deck_port[b].api_name},getItem:function(b){return null==a.slot_itemJson?void 0:-1==b?void 0:a.slot_itemJson.api_data.find(function(a){return a.api_id==b})},getItemStatus:function(b){return void 0===b?void 0:a.api_start2Json.api_data.api_mst_slotitem.find(function(a){return a.api_id==b})},findGirlsWithName:function(b){var c=a.api_start2Json.api_data.api_mst_ship.filter(function(a){return a.api_name.indexOf(b)>-1||a.api_yomi.indexOf(b)>-1});return c==[]?[]:a.portJson.api_data.api_ship.filter(function(a){var b=!1;return c.forEach(function(c){c.api_id==a.api_ship_id&&(console.log("Found: "+a.api_id),b=!0)}),b})},findSlotItemTypesWithName:function(b,c){function d(b){var c=a.slot_itemJson.api_data.find(function(a){return a.api_slotitem_id==b});return void 0!==c}void 0===c&&(c=!0);var e=a.api_start2Json.api_data.api_mst_slotitem.filter(function(a){return c?a.api_name.indexOf(b)>-1&&d(a.api_id):a.api_name.indexOf(b)>-1});return e},findSlotItemOwnerByItemId:function(b){return a.portJson.api_data.api_ship.find(function(a){return a.api_slot.indexOf(b)>-1})},findSlotItemsWithType:function(b){var c={};return a.slot_itemJson.api_data.forEach(function(a){b.indexOf(a.api_slotitem_id)>-1&&(void 0===c[a.api_slotitem_id]?c[a.api_slotitem_id]=[a.api_id]:c[a.api_slotitem_id].push(a.api_id))}),c}}}]),angular.module("kanColleViewerMomiApp").factory("WebSocket",function(){var a=[],b=new ReconnectingWebSocket("ws://localhost:8081/");return b.onopen=function(){console.log("Socket has been opened!"),null!=a.openCallback&&a.openCallback()},b.onmessage=function(b){console.log("Data Incoming"),a.callback(b.data)},b.onclose=function(){null!=a.closeCallback&&a.closeCallback(),console.log("WS reconnected")},b.onerror=function(){console.log("WS error"),null!=a.closeCallback&&a.closeCallback()},a.openCallback=null,a.closeCallback=null,a.callback=null,a.ws=b,a.send=function(a){b.send(a)},a.subscribe=function(b){a.callback=b},a.registerOpening=function(b){a.openCallback=b},a.registerClosing=function(b){a.closeCallback=b},a}),angular.module("kanColleViewerMomiApp").controller("PortCtrl",["$scope","$route","WebSocket","ShipMap","SharedObject","Fleet",function(a,b,c,d,e,f){function g(){null!=e.portJson&&null!=e.slot_itemJson&&(a.teitokuName=h(e.portJson),a.logs=i(e.portJson),a.docks=j(e.portJson),a.fleetsFixDockCount=d.countFleetsOnFix(),a.$apply())}function h(a){return a.api_data.api_basic.api_nickname}function i(a){var b=[];return a.api_data.api_log.forEach(function(a){console.log("log: "+a.api_message);var c=new Object;c.id=a.api_no,c.message=a.api_message,b.push(c)}),b}function j(a){var b=[],c=0;return a.api_data.api_deck_port.forEach(function(a){var g=new Object;g.id=c,g.name=a.api_name;var h=[];a.api_ship.forEach(function(a){var b=d.getFleetFromPort(a),c=f.generateFleetObjectFromAPIFleet(b);void 0!==c&&h.push(c)}),g.ships=h,g.isOnFix=!1,g.ships.forEach(function(a){a.isOnFix&&(g.isOnFix=!0)}),g.isOnMission=1==e.portJson.api_data.api_deck_port[c].api_mission[0],g.airSperiorityIndex=f.calculateAirSperiorityIndexFromGirls(a.api_ship),b.push(g),c++}),b}function k(){if(a.inc.searchString.length>0){a.inc.searching=!0;var b=d.findGirlsWithName(a.inc.searchString),c=d.findSlotItemTypesWithName(a.inc.searchString),e=[];c.forEach(function(a){e.push(a.api_id)});var g=d.findSlotItemsWithType(e),h=[];for(var i in g)g[i].forEach(function(a){var b=d.findSlotItemOwnerByItemId(a);h.push({name:d.getItemStatus(i).api_name,owner:f.generateFleetObjectFromAPIFleet(b),typeId:i,itemId:a})});a.inc.girls=b.map(f.generateFleetObjectFromAPIFleet),a.inc.slotItems=h}else a.inc.searching=!1}null==e.api_start2Json&&(a.needReload=!0),a.teitokuName="Momiji",a.logs=[],a.docks=[],a.hpUnit=1,a.inc={},a.inc.searchString="",a.inc.searchKeyUp=k,e.hook("api_start2",function(){a.needReload=!1,console.log("Received api_start2!"),a.$apply()}),c.registerOpening(function(){a.proxyProblem=!1,a.$apply()}),c.registerClosing(function(){a.proxyProblem=!0,a.$apply()}),e.hook("port",function(){g()}),e.hook("slot_item",function(){g()}),g()}]),angular.module("kanColleViewerMomiApp").controller("DockCtrl",["$sce","$scope","$routeParams","WebSocket","ShipMap","SharedObject","Fleet",function(a,b,c,d,e,f,g){function h(){if(null!=f.portJson&&null!=f.slot_itemJson){var a=c.dockId,d=f.portJson.api_data.api_deck_port[a],h=[];d.api_ship.forEach(function(a){var b=e.getFleetFromPort(a),c=g.generateFleetObjectFromAPIFleet(b);void 0!==c&&h.push(c)}),b.dockId=a,b.girls=h,b.dockName=d.api_name,b.isOnFix=!1,h.forEach(function(a){a.isOnFix&&(b.isOnFix=!0)}),b.isOnMission=1==f.portJson.api_data.api_deck_port[a].api_mission[0],b.airSperiorityIndex=g.calculateAirSperiorityIndexFromGirls(h.map(function(a){return a.id})),h.forEach(function(a,b){h[b].itemDescriptions=g.generateSlotItemsDescription(a.items)}),i(h,0),b.$apply()}}function i(c){var d=0,e=["rgba(77,77,77,0.05)","rgba(93,165,218,0.05)","rgba(250,164,58,0.05)","rgba(96,189,104,0.05)","rgba(222,207,63,0.05)","rgba(241,88,84,0.05)"],f=["rgba(77,77,77,1)","rgba(93,165,218,1)","rgba(250,164,58,1)","rgba(96,189,104,1)","rgba(222,207,63,1)","rgba(241,88,84,1)"],g="rgba(241,124,176,1)",h=[];c.forEach(function(a){var b=a.name,c=[a.maxHp,a.karyoku[0],a.soukou[0],a.raisou[0],a.kaihi[0],a.taiku[0],a.taisen[0],a.sakuteki[0]];h.push({label:b,fillColor:e[d],strokeColor:f[d],pointColor:f[d],pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:c}),d++});var i,j=["耐久","火力","装甲","雷装","回避","対空","対潜","索敵"];if(1==b.chartMode)i={labels:j,datasets:h};else if(-1==b.chartMode){var k=[0,0,0,0,0,0,0,0];h.forEach(function(a){var b=0;j.forEach(function(c){console.log(c+" of "+a.label+" is "+a.data[b]),k[b]+=a.data[b],b++})});var l=[{label:"合計",fillColor:g,strokeColor:f[d],pointColor:f[d],pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:k}];i={labels:j,datasets:l}}var m=$("#status-chart").get(0).getContext("2d"),n=new Chart(m).Radar(i,{scaleShowLabels:!0,pointLabelFontSize:15,legendTemplate:'<% for (var i=0; i<datasets.length; i++){%><span class="label" style="background-color:<%=datasets[i].strokeColor%>"><%if(datasets[i].label){%><%=datasets[i].label%><%}%></span><%}%>'});b.statusChartLegend=a.trustAsHtml(n.generateLegend())}b.hpUnit=1,b.chartMode=1,f.hook("api_start2",function(){b.needReload=!1,console.log("Received api_start2!"),b.$apply()}),d.registerOpening(function(){b.proxyProblem=!1,b.$apply()}),d.registerClosing(function(){b.proxyProblem=!0,b.$apply()}),f.hook("port",function(){h()}),f.hook("slot_item",function(){h()}),h(),b.invertChartMode=function(){b.chartMode=-b.chartMode,console.log("Now, chartMode:"+b.chartMode),i(b.girls)}}]),angular.module("kanColleViewerMomiApp").controller("GirlCtrl",["$scope","$routeParams","WebSocket","ShipMap","SharedObject","Fleet","$sce",function(a,b,c,d,e,f,g){function h(){if(null!=e.portJson&&null!=e.slot_itemJson){a.girlId=b.girlId,a.hpUnit=1;var c=d.getFleetFromPort(a.girlId),g=f.generateFleetObjectFromAPIFleet(c);a.girl=g;var h=d.getDockIdSheBelongsTo(a.girlId);void 0!=h&&(a.herDockId=h,a.herDockName=d.getDockName(a.herDockId));var j=["火力","装甲","雷装","回避","対空","対潜","索敵"],k=[g.karyoku,g.soukou,g.raisou,g.kaihi,g.taiku,g.taisen,g.sakuteki],l=j.map(function(a,b){return[j[b],k[b]]});a.zippedStatus=l,i(j,k),a.items=f.generateSlotItemsDescription(g.items),a.$apply()}}function i(b,c){var d=[],e=[];c.forEach(function(a){e.push(a[0]),d.push(a[1])});var f="rgba(96,189,104,1)",h="rgba(96,189,104,0.05)",i="rgba(93,165,218,1)",j="rgba(93,165,218,0.05)",k={label:"実効値",fillColor:h,strokeColor:f,pointColor:f,pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:e},l={label:"最大基本値",fillColor:j,strokeColor:i,pointColor:i,pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:d},m=[k,l],n={labels:b,datasets:m},o=$("#status-chart").get(0).getContext("2d"),p=new Chart(o).Radar(n,{scaleShowLabels:!0,pointLabelFontSize:15,legendTemplate:'<% for (var i=0; i<datasets.length; i++){%><span class="label" style="background-color:<%=datasets[i].strokeColor%>"><%if(datasets[i].label){%><%=datasets[i].label%><%}%></span><%}%>'});a.statusChartLegend=g.trustAsHtml(p.generateLegend())}e.hook("api_start2",function(){a.needReload=!1,console.log("Received api_start2!"),a.$apply()}),c.registerOpening(function(){a.proxyProblem=!1,a.$apply()}),c.registerClosing(function(){a.proxyProblem=!0,a.$apply()}),e.hook("port",function(){h()}),e.hook("slot_item",function(){h()}),h()}]),angular.module("kanColleViewerMomiApp").factory("Fleet",["ShipMap","SharedObject",function(a,b){function c(b){if(void 0===b)return void 0;var c=new Object;c.hp=b.api_nowhp,c.maxHp=b.api_maxhp,c.hpPercent=Math.round(b.api_nowhp/b.api_maxhp*100),c.id=b.api_id,c.shipId=b.api_ship_id,c.lv=b.api_lv,c.items=b.api_slot.slice(0,b.api_slotnum),c.karyoku=b.api_karyoku,c.soukou=b.api_soukou,c.raisou=b.api_raisou,c.kaihi=b.api_kaihi,c.taiku=b.api_taiku,c.taisen=b.api_taisen,c.sakuteki=b.api_sakuteki,c.un=b.api_lucky;var e=a.fetchShipStatus(b.api_ship_id);c.name=e.api_name;var f=e.api_fuel_max,g=e.api_bull_max;return c.needFuelSupply=b.api_fuel<f,c.needAmmoSupply=b.api_bull<g,c.isOnFix=a.isOnFix(b.api_id),c.isOnFix&&(c.fixTime=c.isOnFix.api_complete_time_str),c.cond=b.api_cond,c.airSperiorityIndex=d(b.api_id),c}function d(c){if(-1==c)return 0;if(null==b.slot_itemJson)return void 0;var d=a.getFleetFromPort(c);if(void 0===d)return void 0;var e=d.api_slot.slice(0,d.api_slotnum),f=d.api_onslot.slice(0,d.api_slotnum),g=e.map(a.getItem).map(function(a){return void 0==a?void 0:a.api_slotitem_id}).map(a.getItemStatus).map(function(a){return void 0===a?0:"[3,5,6,6]"==JSON.stringify(a.api_type)||"[5,7,11,10]"==JSON.stringify(a.api_type)?a.api_tyku:0}),h=g.map(function(a,b){return Math.floor(g[b]*Math.sqrt(f[b]))}).reduce(function(a,b){return a+b});return h}function e(a){var b=0;return a.forEach(function(a){b+=d(a)}),b}function f(b){var c=[];return b.forEach(function(b){var d=a.getItem(b);c.push(void 0!==d?{item:d,status:a.getItemStatus(d.api_slotitem_id)}:void 0)}),c}return{generateFleetObjectFromAPIFleet:c,calculateAirSperiorityIndex:d,calculateAirSperiorityIndexFromGirls:e,generateSlotItemsDescription:f}}]),angular.module("kanColleViewerMomiApp").controller("GirlsCtrl",["$scope","WebSocket","SharedObject","ShipMap","Fleet",function(a,b,c,d,e){function f(){if(null!=c.portJson){var b=[];c.portJson.api_data.api_ship.forEach(function(a){var c=e.generateFleetObjectFromAPIFleet(a);b.push({a:c.id,b:d.getShipTypeNameFromId(d.fetchShipStatus(a.api_ship_id).api_stype),c:c.name,d:c.lv,e:c.cond,f:c.hp,g:c.karyoku[0],h:c.raisou[0],i:c.taiku[0],j:c.soukou[0],k:c.un[0],l:c.sakuteki[0],m:e.calculateAirSperiorityIndex(c.id)})}),a.body=b,a.$apply()}}a.sort={column:"d",descending:!0},a.head={a:"ID",b:"艦種",c:"艦名",d:"LV.",e:"Cond.",f:"HP",g:"火力",h:"雷装",i:"対空",j:"装甲",k:"運",l:"索敵",m:"制空"},a.changeSorting=function(b){var c=a.sort;c.column==b?c.descending=!c.descending:(c.column=b,c.descending=!0)},a.selectedCls=function(b){return b==a.sort.column&&"active"},c.hook("api_start2",function(){a.needReload=!1,console.log("Received api_start2!"),a.$apply()}),b.registerOpening(function(){a.proxyProblem=!1,a.$apply()}),b.registerClosing(function(){a.proxyProblem=!0,a.$apply()}),c.hook("port",function(){f()}),c.hook("slot_item",function(){f()}),f()}]),angular.module("kanColleViewerMomiApp").controller("GirlsStatCtrl",["$scope","SharedObject","ShipMap","Fleet","WebSocket",function(a,b,c,d,e){function f(){if(null!=b.portJson){var c=g();h(c),a.$apply()}}function g(){var a=[];b.portJson.api_data.api_ship.forEach(function(b){console.log(b),console.log(b.api_lv),console.log(Math.floor(b.api_lv/i)),void 0===a[Math.floor(b.api_lv/i)]?a[Math.floor(b.api_lv/i)]=1:a[Math.floor(b.api_lv/i)]++});for(var c=0;c<a.length;c++)void 0===a[c]&&(a[c]=0);return console.log(a),a}function h(a){var b=[];console.log(a),console.log("lngth:"+a.length);for(var c=0;c<a.length;c++)b.push(c*i+"-"+(c*i+i-1));console.log(b);{var d="rgba(96,189,104,1)",e=[{label:"Lv.",fillColor:d,strokeColor:d,highlightFill:"#fff",highlightStroke:"rgba(220,220,220,1)",data:a}],f={labels:b,datasets:e},g=$("#lvhistbar").get(0).getContext("2d");new Chart(g).Bar(f,{scaleShowGridLines:!0})}console.log(f)}var i=5;b.hook("api_start2",function(){a.needReload=!1,console.log("Received api_start2!"),a.$apply()}),e.registerOpening(function(){a.proxyProblem=!1,a.$apply()}),e.registerClosing(function(){a.proxyProblem=!0,a.$apply()}),b.hook("port",function(){f()}),f()}]);