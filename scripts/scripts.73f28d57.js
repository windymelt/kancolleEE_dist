"use strict";angular.module("kanColleViewerMomiApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("kanColleViewerMomiApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("kanColleViewerMomiApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("kanColleViewerMomiApp").service("SharedObject",["WebSocket",function(a){function b(a){d.forEach(function(b){b.api==a&&b.callback()})}console.log("SharedObject created");var c={portJson:null,api_start2Json:null};a.subscribe(function(a){var d=JSON.parse(a);switch(d.api){case"port":c.setPort(d.data),b("port");break;case"api_start2":c.setApi_start2(d.data),b("api_start2")}});var d=[];return c.hook=function(a,b){var c=new Object;c.api=a,c.callback=b,d.push(c)},c.setPort=function(a){c.portJson=a},c.setApi_start2=function(a){c.api_start2Json=a},c}]),angular.module("kanColleViewerMomiApp").factory("ShipMap",["SharedObject",function(a){return{getFleetFromPort:function(b){return $.grep(a.portJson.api_data.api_ship,function(a){return a.api_id==b})[0]},getFixState:function(b){return $.grep(a.portJson.api_data.api_ndock,function(a){return a.api_ship_id==b})[0]},countFleetsOnFix:function(){return a.portJson.api_data.api_ndock.filter(function(a){return 1==a.api_state}).length},fetchShipStatus:function(b){return $.grep(a.api_start2Json.api_data.api_mst_ship,function(a){return a.api_id==b})[0]}}}]),angular.module("kanColleViewerMomiApp").factory("WebSocket",function(){var a=[],b=new ReconnectingWebSocket("ws://localhost:8081/");return b.onopen=function(){console.log("Socket has been opened!"),null!=a.openCallback&&a.openCallback()},b.onmessage=function(b){console.log("Data Incoming"),a.callback(b.data)},b.onclose=function(){null!=a.closeCallback&&a.closeCallback(),console.log("WS reconnected")},b.onerror=function(){console.log("WS error"),null!=a.closeCallback&&a.closeCallback()},a.openCallback=null,a.closeCallback=null,a.callback=null,a.ws=b,a.send=function(a){b.send(a)},a.subscribe=function(b){a.callback=b},a.registerOpening=function(b){a.openCallback=b},a.registerClosing=function(b){a.closeCallback=b},a}),angular.module("kanColleViewerMomiApp").controller("PortCtrl",["$scope","$route","WebSocket","ShipMap","SharedObject",function(a,b,c,d,e){function f(){null!=e.portJson&&(a.teitokuName=g(e.portJson),a.logs=h(e.portJson),a.docks=i(e.portJson),a.fleetsFixDockCount=d.countFleetsOnFix(),a.$apply())}function g(a){return a.api_data.api_basic.api_nickname}function h(a){var b=[];return a.api_data.api_log.forEach(function(a){console.log("log: "+a.api_message);var c=new Object;c.id=a.api_no,c.message=a.api_message,b.push(c)}),b}function i(a){var b=[];return a.api_data.api_deck_port.forEach(function(a){var c=new Object;c.name=a.api_name;var e=[];a.api_ship.forEach(function(a){var b=d.getFleetFromPort(a),c=j(b);void 0!==c&&e.push(c)}),c.ships=e,b.push(c)}),b}function j(a){if(void 0===a)return void 0;var b=new Object;b.hpPercent=a.api_nowhp/a.api_maxhp*100,b.id=a.api_id,b.shipId=a.api_ship_id,b.lv=a.api_lv;var c=d.fetchShipStatus(a.api_ship_id);b.name=c.api_name;var e=c.api_fuel_max,f=c.api_bull_max;return b.needFuelSupply=a.api_fuel<e,b.needAmmoSupply=a.api_bull<f,b.fixState=d.getFixState(a.api_id),b.fixState&&(b.fixTime=b.fixState.api_complete_time_str),b}null==e.api_start2Json&&(a.needReload=!0),a.teitokuName="Momiji",a.logs=[],a.docks=[],e.hook("api_start2",function(){a.needReload=!1,console.log("Received api_start2!"),a.$apply()}),c.registerOpening(function(){a.proxyProblem=!1,a.$apply()}),c.registerClosing(function(){a.proxyProblem=!0,a.$apply()}),e.hook("port",function(){f()}),f()}]);